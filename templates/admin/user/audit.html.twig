{% extends 'base.html.twig' %}

{% block title %}Journal d'Audit Administrateur
{% endblock %}

{% block body %}
	<div class="container-fluid mt-4">
		<div class="row">
			<div class="col-12">
				<div class="d-flex justify-content-between align-items-center mb-4">
					<h1>Journal d'Audit Administrateur</h1>
					<a href="{{ path('admin_user_index') }}" class="btn btn-secondary">
						<i class="bi bi-arrow-left"></i>
						Retour
					</a>
				</div>

				<div class="row mb-4">
					<div class="col-md-3">
						<div class="card text-center">
							<div class="card-body">
								<h6 class="text-muted mb-2">Total affiché</h6>
								<h2 class="mb-0">{{ stats.total }}</h2>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="card text-center">
							<div class="card-body">
								<h6 class="text-muted mb-2">Dernières 24h</h6>
								<h2 class="mb-0">{{ stats.last24h }}</h2>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="card text-center">
							<div class="card-body">
								<h6 class="text-muted mb-2">Derniers 7 jours</h6>
								<h2 class="mb-0">{{ stats.last7days }}</h2>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="card">
							<div class="card-body">
								<h6 class="text-muted mb-2">Actions principales</h6>
								{% for stat in stats.byAction|slice(0, 3) %}
									<div class="d-flex justify-content-between">
										<small>{{ stat.action }}</small>
										<small>
											<strong>{{ stat.count }}</strong>
										</small>
									</div>
								{% endfor %}
							</div>
						</div>
					</div>
				</div>

				<div class="card mb-4">
					<div class="card-header">
						<h5 class="mb-0">
							<i class="bi bi-funnel"></i>
							Filtres</h5>
					</div>
					<div class="card-body">
						<form method="get" action="{{ path('admin_user_audit') }}">
							<div class="row g-3">
								<div class="col-md-3">
									<label for="action" class="form-label">Action</label>
									<select name="action" id="action" class="form-select">
										<option value="">Toutes les actions admin</option>
										<option value="user_update" {% if filters.action == 'user_update' %} selected {% endif %}>Modification utilisateur</option>
										<option value="user_delete" {% if filters.action == 'user_delete' %} selected {% endif %}>Suppression utilisateur</option>
										<option value="user_suspend" {% if filters.action == 'user_suspend' %} selected {% endif %}>Suspension utilisateur</option>
										<option value="user_unsuspend" {% if filters.action == 'user_unsuspend' %} selected {% endif %}>Réactivation utilisateur</option>
									</select>
								</div>
								<div class="col-md-3">
									<label for="user_id" class="form-label">Utilisateur</label>
									<select name="user_id" id="user_id" class="form-select">
										<option value="">Tous les utilisateurs</option>
										{% for user in allUsers %}
											<option value="{{ user.id }}" {% if filters.user_id == user.id %} selected {% endif %}>
												{{ user.email }}
											</option>
										{% endfor %}
									</select>
								</div>
								<div class="col-md-2">
									<label for="date_from" class="form-label">Date début</label>
									<input type="date" name="date_from" id="date_from" class="form-control" value="{{ filters.date_from }}">
								</div>
								<div class="col-md-2">
									<label for="date_to" class="form-label">Date fin</label>
									<input type="date" name="date_to" id="date_to" class="form-control" value="{{ filters.date_to }}">
								</div>
								<div class="col-md-2">
									<label for="limit" class="form-label">Limite</label>
									<select name="limit" id="limit" class="form-select">
										<option value="50" {% if filters.limit == 50 %} selected {% endif %}>50</option>
										<option value="100" {% if filters.limit == 100 %} selected {% endif %}>100</option>
										<option value="200" {% if filters.limit == 200 %} selected {% endif %}>200</option>
										<option value="500" {% if filters.limit == 500 %} selected {% endif %}>500</option>
									</select>
								</div>
							</div>
							<div class="mt-3">
								<button type="submit" class="btn btn-primary">
									<i class="bi bi-search"></i>
									Filtrer
								</button>
								<a href="{{ path('admin_user_audit') }}" class="btn btn-outline-secondary">
									<i class="bi bi-x-circle"></i>
									Réinitialiser
								</a>
							</div>
						</form>
					</div>
				</div>

				<div class="card">
					<div class="card-header">
						<h5 class="mb-0">
							<i class="bi bi-list-ul"></i>
							Entrées du journal ({{ stats.total }})</h5>
					</div>
					<div class="card-body p-0">
						{% if logs is empty %}
							<div class="p-4 text-center text-muted">
								<i class="bi bi-inbox" style="font-size: 3rem;"></i>
								<p class="mt-2">Aucune entrée trouvée avec ces filtres</p>
							</div>
						{% else %}
							<div class="table-responsive">
								<table class="table table-hover table-striped mb-0">
									<thead class="table-dark">
										<tr>
											<th width="50"></th>
											<th>Date/Heure</th>
											<th>Utilisateur</th>
											<th>Action</th>
											<th>Détails</th>
											<th>Adresse IP</th>
											<th>Navigateur</th>
										</tr>
									</thead>
									<tbody>
										{% for log in logs %}
											<tr>
												<td class="text-center">
													<span style="font-size: 1.3rem;">{{ log.actionIcon }}</span>
												</td>
												<td>
													<strong>{{ log.createdAt|date('d/m/Y') }}</strong><br>
													<small class="text-muted">{{ log.createdAt|date('H:i:s') }}</small>
												</td>
												<td>
													<strong>{{ log.user.email }}</strong><br>
													<small class="text-muted">
														{{ log.user.firstname }}
														{{ log.user.lastname }}
													</small>
												</td>
												<td>
													<span class="badge bg-primary">{{ log.actionLabel }}</span>
												</td>
												<td>
													{% if log.details %}
														<small>{{ log.details }}</small>
													{% else %}
														<span class="text-muted">-</span>
													{% endif %}
												</td>
												<td>
													<code>{{ log.ipAddress }}</code>
												</td>
												<td>
													{% if log.userAgent %}
														<small class="text-muted" title="{{ log.userAgent }}">
															{{ log.userAgent|length > 40 ? log.userAgent|slice(0, 40) ~ '...' : log.userAgent }}
														</small>
													{% else %}
														<span class="text-muted">-</span>
													{% endif %}
												</td>
											</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</div>

	<style>
		.card {
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			transition: all 0.3s ease;
		}

		.card:hover {
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
		}

		table thead th {
			font-weight: 600;
			text-transform: uppercase;
			font-size: 0.85rem;
			letter-spacing: 0.5px;
		}

		tbody tr {
			transition: background-color 0.2s ease;
		}

		tbody tr:hover {
			background-color: rgba(0, 0, 0, 0.02) !important;
		}

		code {
			background-color: #f8f9fa;
			padding: 2px 6px;
			border-radius: 3px;
			font-size: 0.9em;
		}
	</style>
{% endblock %}
