{% extends 'base.html.twig' %}

{% block body %}
    <h1>Gestion des utilisateurs</h1>

    <div class="mb-3">
        <a href="{{ path('admin_user_audit') }}" class="btn btn-info">Journal d'Audit</a>
    </div>

    <!-- Formulaire de recherche et filtres -->
    <form method="get" class="mb-3" style="display:flex; gap:20px; align-items:flex-end;">

        <div>
            <label class="form-label mb-1">Recherche</label>
            <input type="text" id="user-quick-search" name="search" class="form-control"
                   placeholder="Email, nom, prénom..."
                   value="{{ app.request.get('search') }}">
        </div>

        <div>
            <label class="form-label mb-1">Rôle</label>
            <select name="role" class="form-select">
                <option value="">Tous les rôles</option>
                <option value="ROLE_USER"
                    {% if app.request.get('role') == 'ROLE_USER' %}selected{% endif %}>
                    Utilisateur
                </option>
                <option value="ROLE_ADMIN"
                    {% if app.request.get('role') == 'ROLE_ADMIN' %}selected{% endif %}>
                    Administrateur
                </option>
            </select>
        </div>

        <div>
            <label class="form-label mb-1">Statut</label>
            <select name="suspended" class="form-select">
                <option value="">Tous</option>
                <option value="1" {% if app.request.get('suspended') == '1' %}selected{% endif %}>
                    Suspendus
                </option>
                <option value="0" {% if app.request.get('suspended') == '0' %}selected{% endif %}>
                    Actifs
                </option>
            </select>
        </div>

        <div>
            <button type="submit" class="btn btn-primary">Filtrer</button>
            <a href="{{ path('admin_user_index') }}" class="btn btn-outline-secondary">Réinitialiser</a>
        </div>

    </form>

	<div class="mb-3">
    <span class="badge bg-primary">Total : {{ total }}</span>
    <span class="badge bg-success">Actifs : {{ active }}</span>
    <span class="badge bg-danger">Suspendus : {{ suspended }}</span>
</div>



    <table class="table table-striped table-hover">
        <tr>
         <thread>
            <th>Email</th>
            <th>Nom</th>
            <th>Rôles</th>
            <th>Statut</th>
            <th>Actions</th>
        </tr>
        </thread>
         <tbody>
        {% for user in users %}
            <tr>
                <td>{{ user.email }}</td>
                <td>{{ user.firstname }} {{ user.lastname }}</td>
                <td>{{ user.roles|join(', ') }}</td>
                <td>
                    {% if user.isSuspended %}
                        <span class="text-danger">Suspendu</span>
                    {% else %}
                        Actif
                    {% endif %}
                </td>
                <td>
                    <a href="{{ path('admin_user_edit', {id: user.id}) }}">Modifier</a> |
                    <a href="{{ path('admin_user_single_history', {id: user.id}) }}">Historique</a> |
                    <a href="{{ path('admin_user_toggle_suspend', {id: user.id}) }}">
                        {% if user.isSuspended %}Réactiver{% else %}Suspendre{% endif %}
                    </a> |
                    <form action="{{ path('admin_user_delete', {id: user.id}) }}" method="post" style="display:inline;">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete_user_' ~ user.id) }}">
                        <button type="submit" class="btn btn-link p-0">Supprimer</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
         </tbody>
    </table>
	{% if totalPages > 1 %}
<nav aria-label="Pagination utilisateur" class="mt-3">
    <ul class="pagination">

       
        <li class="page-item {% if currentPage == 1 %}disabled{% endif %}">
            <a class="page-link"
               href="{{ path('admin_user_index', app.request.query.all | merge({'page': currentPage - 1})) }}">
                Précédent
            </a>
        </li>

       
        {% for p in 1..totalPages %}
            <li class="page-item {% if p == currentPage %}active{% endif %}">
                <a class="page-link"
                   href="{{ path('admin_user_index', app.request.query.all | merge({'page': p})) }}">
                    {{ p }}
                </a>
            </li>
        {% endfor %}

        
        <li class="page-item {% if currentPage == totalPages %}disabled{% endif %}">
            <a class="page-link"
               href="{{ path('admin_user_index', app.request.query.all | merge({'page': currentPage + 1})) }}">
                Suivant
            </a>
        </li>

    </ul>
</nav>
{% endif %}

{% endblock %}
